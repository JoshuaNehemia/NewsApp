<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Detail Berita</ion-title>
    <ion-buttons slot="end" *ngIf="article && currentUser.username === article.author_username">
      <ion-button color="danger" (click)="deleteNews()">
        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content *ngIf="article">
  <img [src]="selectedImage" class="main-image" />

  <div class="ion-padding">
    <div style="margin-bottom: 10px;" *ngIf="article.categories && article.categories.length > 0">
      <p style="color: var(--ion-color-primary); font-weight: 500; font-size: 1.1em; margin: 0;">
        <ng-container *ngFor="let cat of article.categories; let last = last">{{ cat }}{{ !last ? ', ' : ''
          }}</ng-container>
      </p>
    </div>

    <h1>{{ article.title }}</h1>

    <p style="color: gray; font-size: 0.9rem;">
      {{ article.author }} â€¢ {{ article.date | date:'mediumDate' }}
    </p>

    <div class="content-text" [innerHTML]="article.content"></div>
  </div>

  <div class="ion-padding-horizontal" *ngIf="article.images.length > 0">
    <p><strong>Galeri:</strong></p>
    <ion-segment scrollable [value]="selectedImage">
      <ion-segment-button *ngFor="let img of article.images" [value]="img" (click)="selectImage(img)">
        <img [src]="img" style="width: 80px; height: 60px; object-fit: cover; border-radius: 8px;" />
      </ion-segment-button>
    </ion-segment>
  </div>

  <div class="stats-bar ion-padding-horizontal ion-margin-top">
    <div class="stat-item">
      <ion-icon name="eye-outline"></ion-icon>
      <span>{{ article.view_count }}</span>
    </div>

    <div class="stat-item" (click)="toggleLike()">
      <ion-icon [name]="article.user_status === 1 ? 'heart' : 'heart-outline'"
        [color]="article.user_status === 1 ? 'danger' : 'medium'">
      </ion-icon>
      <span>{{ article.like_count }}</span>
    </div>

    <div class="stat-item" (click)="toggleDislike()">
      <ion-icon [name]="article.user_status === 0 ? 'thumbs-down' : 'thumbs-down-outline'"
        [color]="article.user_status === 0 ? 'primary' : 'medium'">
      </ion-icon>
      <span>{{ article.dislike_count || 0 }}</span>
    </div>

    <div class="stat-item">
      <ion-icon name="chatbubble-outline"></ion-icon>
      <span>{{ article.comment_count }}</span>
    </div>
  </div>

  <div class="ion-padding-horizontal ion-margin-top" *ngIf="article.tags && article.tags.length > 0">
    <ion-chip *ngFor="let tag of article.tags" outline="true" color="medium">
      <ion-label>#{{ tag }}</ion-label>
    </ion-chip>
  </div>

  <ion-item lines="none" class="ion-padding-top" style="align-items: center;">
    <ion-label style="min-width: 80px;"><strong>Rating:</strong></ion-label>

    <div style="display: flex; align-items: center; gap: 5px; margin-right: 10px;">
      <ion-icon name="star" color="warning"></ion-icon>
      <span>{{ article.rating | number:'1.1-1' }}</span>
      <span style="color: #666; font-size: 0.9rem;" *ngIf="article.rating_count > 0">({{ article.rating_count }})</span>
    </div>

    <div style="display: flex;">
      <ion-button fill="clear" size="small" *ngFor="let i of [1, 2, 3, 4, 5]" (click)="rateNews(i)">
        <ion-icon [name]="i <= userRating ? 'star' : 'star-outline'"
          [color]="i <= userRating ? 'warning' : 'medium'"></ion-icon>
      </ion-button>
    </div>
  </ion-item>

  <div class="ion-padding">
    <h3>Komentar ({{ article.comment_count }})</h3>

    <ion-item class="ion-margin-bottom input-comment">
      <ion-textarea [(ngModel)]="newComment" placeholder="Tulis komentar..." rows="1"></ion-textarea>
      <ion-button (click)="addComment()" slot="end" fill="clear">
        <ion-icon name="send"></ion-icon>
      </ion-button>
    </ion-item>

    <ion-list lines="none">
      <!-- Top-level comments -->
      <ng-container *ngFor="let com of article.comments">
        <!-- Main comment -->
        <ion-item class="chat-item">
          <ion-avatar slot="start">
            <img [src]="com.user?.avatar || 'assets/images/default-user.png'" />
          </ion-avatar>
          <ion-label>
            <div class="chat-header">
              <strong>{{ com.user?.name || com.username }}</strong>
              <span class="chat-date">{{ com.date | date:'short' }}</span>
            </div>
            <p class="chat-text">{{ com.text }}</p>

            <!-- Reply button -->
            <ion-button fill="clear" size="small" (click)="toggleReply(com.id)">
              <ion-icon name="arrow-undo-outline" slot="start"></ion-icon>
              Reply
            </ion-button>

            <!-- Reply input (conditional) -->
            <ion-item *ngIf="replyingTo === com.id" lines="none" class="reply-input">
              <ion-textarea [(ngModel)]="replyText" placeholder="Tulis balasan..." rows="1"
                class="ion-margin-top"></ion-textarea>
              <ion-button (click)="addReply(com.id)" slot="end" fill="clear" size="small">
                <ion-icon name="send"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-label>
        </ion-item>

        <!-- Nested replies (with indentation) -->
        <ng-container *ngIf="com.replies && com.replies.length > 0">
          <ion-item *ngFor="let reply of com.replies" class="chat-item reply-item" style="padding-left: 40px;">
            <ion-avatar slot="start" size="small">
              <img [src]="reply.user?.avatar || 'assets/images/default-user.png'" />
            </ion-avatar>
            <ion-label>
              <div class="chat-header">
                <strong>{{ reply.user?.name || reply.username }}</strong>
                <span class="chat-date">{{ reply.date | date:'short' }}</span>
              </div>
              <p class="chat-text">{{ reply.text }}</p>

              <!-- Reply to reply button -->
              <ion-button fill="clear" size="small" (click)="toggleReply(reply.id)">
                <ion-icon name="arrow-undo-outline" slot="start"></ion-icon>
                Reply
              </ion-button>

              <!-- Reply input for nested reply -->
              <ion-item *ngIf="replyingTo === reply.id" lines="none" class="reply-input">
                <ion-textarea [(ngModel)]="replyText" placeholder="Tulis balasan..." rows="1"
                  class="ion-margin-top"></ion-textarea>
                <ion-button (click)="addReply(com.id)" slot="end" fill="clear" size="small">
                  <ion-icon name="send"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-label>
          </ion-item>
        </ng-container>
      </ng-container>
    </ion-list>
  </div>

</ion-content>